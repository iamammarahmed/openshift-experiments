apiVersion: batch/v1
kind: Job
metadata:
  name: s3-bucket-usage-job
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: usage
          image: amazon/aws-cli:latest
          env:
            - name: BUCKET
              value: my-bucket
            - name: BUCKET_CAPACITY_GB
              value: "100"
          envFrom:
            - secretRef:
                name: s3-credentials
          command:
            - /bin/sh
            - -c
            - |
              if [ "${AWS_ENDPOINT_URL#http}" = "$AWS_ENDPOINT_URL" ]; then
                AWS_ENDPOINT_URL="http://$AWS_ENDPOINT_URL"
              fi
              USED=$(aws s3 ls s3://$BUCKET --recursive --summarize | awk '/Total Size/ {print $3}')
              CAPACITY_BYTES=$((BUCKET_CAPACITY_GB*1024*1024*1024))
              FREE_BYTES=$((CAPACITY_BYTES-USED))
              USED_GB=$(awk "BEGIN {printf \"%.2f\", $USED/1024/1024/1024}")
              FREE_GB=$(awk "BEGIN {printf \"%.2f\", $FREE_BYTES/1024/1024/1024}")
              USAGE_PERCENT=$((USED*100/CAPACITY_BYTES))
              echo "Bucket capacity: $BUCKET_CAPACITY_GB GB"
              echo "Used: $USED_GB GB"
              echo "Free: $FREE_GB GB"
              echo "Usage: $USAGE_PERCENT%"
              if [ "$USAGE_PERCENT" -gt 98 ]; then
                echo "Usage exceeds 98%, deleting objects older than 30 days"
                THRESHOLD=$(date -d '30 days ago' +%s)
                aws s3 ls s3://$BUCKET --recursive | while read -r line; do
                  FILE_DATE=$(echo $line | awk '{print $1" "$2}')
                  FILE_EPOCH=$(date -d "$FILE_DATE" +%s)
                  if [ $FILE_EPOCH -lt $THRESHOLD ]; then
                    KEY=$(echo $line | awk '{print $4}')
                    aws s3 rm s3://$BUCKET/$KEY
                  fi
                done
              fi
